{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
# run_once_after_99-configure-system.sh.tmpl

TARGET_NAME="{{ .hostname }}"
CURRENT_NAME=$(hostname)

echo "--- System Configuration ---"

# Function to check if running as root
is_root() {
    [ "$(id -u)" -eq 0 ]
}

# 1. Tailscale Configuration (Automatic)
if command -v tailscale >/dev/null 2>&1; then
    echo "Found Tailscale. Checking status..."

    # WSL-specific check: Do not mess with resolv.conf on WSL.
    # It causes "Temporary failure in name resolution" because Tailscale and WSL's internal vSwitch conflict.
    if grep -iq "microsoft" /proc/version 2>/dev/null || grep -iq "wsl" /proc/version 2>/dev/null; then
        echo "WSL detected. Skipping resolv.conf modifications to prevent DNS breakage."
    fi

    # Check if logged in (status returns exit code 1 if not running/logged out usually)
    if ! tailscale status >/dev/null 2>&1; then
        echo "Tailscale is not logged in. Attempting auto-auth via Bitwarden..."

        if [ -n "$BW_SESSION" ]; then
             TS_KEY=$(bw get password "tailscale-auth-key")
             if [ -n "$TS_KEY" ]; then
                 echo "Tailscale Auth Key retrieved. Authenticating as '$TARGET_NAME'..."
                 if is_root; then
                     tailscale up --authkey "$TS_KEY" --hostname "$TARGET_NAME" --accept-routes
                 else
                     sudo tailscale up --authkey "$TS_KEY" --hostname "$TARGET_NAME" --accept-routes
                 fi
                 echo "Tailscale Connected Successfully!"
             else
                 echo "Warning: Retrieved empty Tailscale key."
             fi
        else
            echo "Warning: Bitwarden session not active. Skipping Tailscale auto-login."
        fi
    else
        echo "Tailscale is already logged in. Updating hostname preference..."
        if is_root; then
            tailscale set --hostname "$TARGET_NAME"
        else
            sudo tailscale set --hostname "$TARGET_NAME"
        fi
    fi
fi

# 2. OS Hostname Configuration (Prompt)
if [ "$CURRENT_NAME" != "$TARGET_NAME" ]; then
    echo -e "Current Hostname: \033[33m$CURRENT_NAME\033[0m"
    echo -e "Target Mythos Name:  \033[32m$TARGET_NAME\033[0m"
    echo "Hostname mismatch detected. Auto-correcting to match Mythos..."
    
    # Check if WSL -> skip manual hostname injection since we rely on `wsl.conf`
    if grep -iq "microsoft" /proc/version 2>/dev/null || grep -iq "wsl" /proc/version 2>/dev/null; then
        echo "WSL detected. Skipping manual hostnamectl and /etc/hosts modification (handled via wsl.conf instead)."
    else
        echo "Renaming system..."
        
        if command -v hostnamectl >/dev/null 2>&1; then
            # Systemd method
            if is_root; then
                hostnamectl set-hostname "$TARGET_NAME"
            else
                sudo hostnamectl set-hostname "$TARGET_NAME"
            fi

            # Update /etc/hosts to prevent sudo warnings (systemd doesn't do this automatically)
            if grep -q "127.0.1.1" /etc/hosts; then
                if is_root; then
                    sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
                else
                    sudo sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
                fi
            else
                if is_root; then
                    echo -e "127.0.1.1\t$TARGET_NAME" >> /etc/hosts
                else
                    echo -e "127.0.1.1\t$TARGET_NAME" | sudo tee -a /etc/hosts > /dev/null
                fi
            fi
        else
            # Legacy method
            if is_root; then
                hostname "$TARGET_NAME"
                echo "$TARGET_NAME" > /etc/hostname
            else
                sudo hostname "$TARGET_NAME"
                echo "$TARGET_NAME" | sudo tee /etc/hostname > /dev/null
            fi
            
            # Update /etc/hosts to prevent sudo warnings
            if grep -q "127.0.1.1" /etc/hosts; then
                if is_root; then
                    sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
                else
                    sudo sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
                fi
            else
                if is_root; then
                    echo -e "127.0.1.1\t$TARGET_NAME" >> /etc/hosts
                else
                    echo -e "127.0.1.1\t$TARGET_NAME" | sudo tee -a /etc/hosts > /dev/null
                fi
            fi
        fi
    fi

    # WSL Specific Hostname persistence block
    if grep -iq "microsoft" /proc/version 2>/dev/null || grep -iq "wsl" /proc/version 2>/dev/null; then
        echo -e "\033[33mWSL Environment detected. Persisting hostname in /etc/wsl.conf...\033[0m"
        WSL_CONF_UPDATED=false
        # Inject network section if it doesn't exist
        if ! grep -iq "\[network\]" /etc/wsl.conf 2>/dev/null; then
            if is_root; then echo -e "\n[network]" >> /etc/wsl.conf; else echo -e "\n[network]" | sudo tee -a /etc/wsl.conf > /dev/null; fi
        fi
        
        # Ensure hostname is set
        if ! grep -iq "hostname[[:space:]]*=" /etc/wsl.conf 2>/dev/null; then
            if is_root; then sed -i '/\[network\]/a hostname='"$TARGET_NAME" /etc/wsl.conf; else sudo sed -i '/\[network\]/a hostname='"$TARGET_NAME" /etc/wsl.conf; fi
            WSL_CONF_UPDATED=true
        else
            # Replace existing hostname value
            if is_root; then sed -i 's/^hostname[[:space:]]*=.*/hostname='"$TARGET_NAME"'/' /etc/wsl.conf; else sudo sed -i 's/^hostname[[:space:]]*=.*/hostname='"$TARGET_NAME"'/' /etc/wsl.conf; fi
            WSL_CONF_UPDATED=true
        fi
        
        # Disable auto-generation of hosts file if needed, so our changes above aren't wiped
        if ! grep -iq "generateHosts[[:space:]]*=" /etc/wsl.conf 2>/dev/null; then
            if is_root; then sed -i '/\[network\]/a generateHosts=false' /etc/wsl.conf; else sudo sed -i '/\[network\]/a generateHosts=false' /etc/wsl.conf; fi
            WSL_CONF_UPDATED=true
        fi

        if [ "$WSL_CONF_UPDATED" = true ]; then
            echo -e "\033[33m/etc/wsl.conf updated. You MUST restart WSL ('wsl --shutdown' in Windows) for the permanent hostname to take effect.\033[0m"
        fi
    fi
    
    echo -e "\033[32mSuccess: Hostname changed to '$TARGET_NAME'. Please restart your system.\033[0m"
else
    echo -e "\033[32mSystem Hostname is already synced.\033[0m"
fi

# 3. SSH Server Configuration (auto-start for all Linux systems)
if command -v sshd >/dev/null 2>&1; then
    echo "Checking SSH server status..."

    # Check if SSH service is running
    if ! systemctl is-active --quiet ssh 2>/dev/null && ! systemctl is-active --quiet sshd 2>/dev/null; then
        echo "SSH server is not running. Starting service..."
        SSH_STARTED=false
        if is_root; then
            if systemctl start ssh 2>/dev/null || systemctl start sshd 2>/dev/null || service ssh start 2>/dev/null; then
                SSH_STARTED=true
            fi
            systemctl enable ssh 2>/dev/null || systemctl enable sshd 2>/dev/null || true
        else
            if sudo systemctl start ssh 2>/dev/null || sudo systemctl start sshd 2>/dev/null || sudo service ssh start 2>/dev/null; then
                SSH_STARTED=true
            fi
            sudo systemctl enable ssh 2>/dev/null || sudo systemctl enable sshd 2>/dev/null || true
        fi

        if [ "$SSH_STARTED" = true ]; then
            echo -e "\033[32mSSH server started and enabled.\033[0m"
        else
            echo -e "\033[33mWarning: Failed to start SSH server. Please check service status manually.\033[0m"
        fi
    else
        echo -e "\033[32mSSH server is already running.\033[0m"
    fi
else
    echo "Note: SSH server (sshd) not found. Run 'sudo apt install openssh-server' if needed."
fi
{{ end }}
