{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
# run_once_after_99-configure-system.sh.tmpl

TARGET_NAME="{{ .hostname }}"
CURRENT_NAME=$(hostname)

echo "--- System Configuration ---"

# Function to check if running as root
is_root() {
    [ "$(id -u)" -eq 0 ]
}

# 1. Tailscale Configuration (Automatic)
if command -v tailscale >/dev/null 2>&1; then
    echo "Found Tailscale. Checking status..."

    # Ensure resolv.conf is writable for MagicDNS (WSL-specific fix)
    if [ -f /etc/resolv.conf ]; then
        # Check if file is immutable (only if lsattr is available)
        if command -v lsattr >/dev/null 2>&1; then
            if lsattr /etc/resolv.conf 2>/dev/null | grep -q -- '----i'; then
                echo "Removing immutable flag from /etc/resolv.conf for MagicDNS..."
                if is_root; then
                    chattr -i /etc/resolv.conf 2>/dev/null || true
                else
                    sudo chattr -i /etc/resolv.conf 2>/dev/null || true
                fi
            fi
        fi
    fi

    # Check if logged in (status returns exit code 1 if not running/logged out usually)
    if ! tailscale status >/dev/null 2>&1; then
        echo "Tailscale is not logged in. Attempting auto-auth via Bitwarden..."

        if [ -n "$BW_SESSION" ]; then
             TS_KEY=$(bw get password "tailscale-auth-key")
             if [ -n "$TS_KEY" ]; then
                 echo "Tailscale Auth Key retrieved. Authenticating as '$TARGET_NAME'..."
                 if is_root; then
                     tailscale up --authkey "$TS_KEY" --hostname "$TARGET_NAME" --accept-routes
                 else
                     sudo tailscale up --authkey "$TS_KEY" --hostname "$TARGET_NAME" --accept-routes
                 fi
                 echo "Tailscale Connected Successfully!"
             else
                 echo "Warning: Retrieved empty Tailscale key."
             fi
        else
            echo "Warning: Bitwarden session not active. Skipping Tailscale auto-login."
        fi
    else
        echo "Tailscale is already logged in. Updating hostname preference..."
        if is_root; then
            tailscale set --hostname "$TARGET_NAME"
        else
            sudo tailscale set --hostname "$TARGET_NAME"
        fi
    fi
fi

# 2. OS Hostname Configuration (Prompt)
if [ "$CURRENT_NAME" != "$TARGET_NAME" ]; then
    echo -e "Current Hostname: \033[33m$CURRENT_NAME\033[0m"
    echo -e "Target Mythos Name:  \033[32m$TARGET_NAME\033[0m"
    echo "Hostname mismatch detected. Auto-correcting to match Mythos..."
    
    echo "Renaming system..."
    
    if command -v hostnamectl >/dev/null 2>&1; then
        # Systemd method
        if is_root; then
            hostnamectl set-hostname "$TARGET_NAME"
        else
            sudo hostnamectl set-hostname "$TARGET_NAME"
        fi

        # Update /etc/hosts to prevent sudo warnings (systemd doesn't do this automatically)
        if grep -q "127.0.1.1" /etc/hosts; then
            if is_root; then
                sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
            else
                sudo sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
            fi
        else
            if is_root; then
                echo -e "127.0.1.1\t$TARGET_NAME" >> /etc/hosts
            else
                echo -e "127.0.1.1\t$TARGET_NAME" | sudo tee -a /etc/hosts > /dev/null
            fi
        fi
    else
        # Legacy method
        if is_root; then
            hostname "$TARGET_NAME"
            echo "$TARGET_NAME" > /etc/hostname
        else
            sudo hostname "$TARGET_NAME"
            echo "$TARGET_NAME" | sudo tee /etc/hostname > /dev/null
        fi
        
        # Update /etc/hosts to prevent sudo warnings
        if grep -q "127.0.1.1" /etc/hosts; then
            if is_root; then
                sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
            else
                sudo sed -i "s/^127.0.1.1.*/127.0.1.1\t$TARGET_NAME/" /etc/hosts
            fi
        else
            if is_root; then
                echo -e "127.0.1.1\t$TARGET_NAME" >> /etc/hosts
            else
                echo -e "127.0.1.1\t$TARGET_NAME" | sudo tee -a /etc/hosts > /dev/null
            fi
        fi
    fi
    
    echo -e "\033[32mSuccess: Hostname changed to '$TARGET_NAME'. Please restart your system.\033[0m"
else
    echo -e "\033[32mSystem Hostname is already synced.\033[0m"
fi

# 3. SSH Server Configuration (auto-start for all Linux systems)
if command -v sshd >/dev/null 2>&1; then
    echo "Checking SSH server status..."

    # Check if SSH service is running
    if ! systemctl is-active --quiet ssh 2>/dev/null && ! systemctl is-active --quiet sshd 2>/dev/null; then
        echo "SSH server is not running. Starting service..."
        SSH_STARTED=false
        if is_root; then
            if systemctl start ssh 2>/dev/null || systemctl start sshd 2>/dev/null || service ssh start 2>/dev/null; then
                SSH_STARTED=true
            fi
            systemctl enable ssh 2>/dev/null || systemctl enable sshd 2>/dev/null || true
        else
            if sudo systemctl start ssh 2>/dev/null || sudo systemctl start sshd 2>/dev/null || sudo service ssh start 2>/dev/null; then
                SSH_STARTED=true
            fi
            sudo systemctl enable ssh 2>/dev/null || sudo systemctl enable sshd 2>/dev/null || true
        fi

        if [ "$SSH_STARTED" = true ]; then
            echo -e "\033[32mSSH server started and enabled.\033[0m"
        else
            echo -e "\033[33mWarning: Failed to start SSH server. Please check service status manually.\033[0m"
        fi
    else
        echo -e "\033[32mSSH server is already running.\033[0m"
    fi
else
    echo "Note: SSH server (sshd) not found. Run 'sudo apt install openssh-server' if needed."
fi
{{ end }}
