{{- if eq .chezmoi.os "windows" -}}
$ErrorActionPreference = "Continue"

# Trigger execution when these templates change:
# {{ include "private_dot_ssh/private_id_ed25519_dotfiles_master.tmpl" | sha256sum }}
# {{ include "private_dot_ssh/private_id_ed25519_dotfiles_server.tmpl" | sha256sum }}

$sshDir = "$HOME/.ssh"
$keys = @("id_ed25519_dotfiles_master", "id_ed25519_dotfiles_server")

Write-Host "--- Checking SSH Public Keys ---" -ForegroundColor Cyan

if (Test-Path $sshDir) {
    foreach ($key in $keys) {
        $privateKeyPath = Join-Path $sshDir $key
        $publicKeyPath = "$privateKeyPath.pub"
        
        if (Test-Path $privateKeyPath) {
            # Always ensure pub key exists/updates if private key exists
            # We don't check if pub key exists, we just overwrite to be safe? 
            # OR check if missing. ssh-keygen -y is fast.
            
            Write-Host "Deriving public key for $key..." -ForegroundColor Gray
            try {
                $pubKeyContent = ssh-keygen -y -f "$privateKeyPath"
                if ($pubKeyContent) {
                    $pubKeyContent | Out-File -FilePath $publicKeyPath -Encoding ascii -NoNewline
                    Write-Host "Generated: $publicKeyPath" -ForegroundColor Green
                }
            } catch {
                Write-Warning "Failed to derive public key for ${key}: $_"
            }
        }
    }
}
{{- end -}}
