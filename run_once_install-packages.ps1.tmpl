{{ if eq .chezmoi.os "windows" }}
# run_once_install-packages.ps1.tmpl
# This script runs only when the hash of this file changes.
# Sync status: Match Linux improvements (2026-02-24)

Write-Host "Starting Windows Package Installation via Winget..." -ForegroundColor Cyan

{{ $pkgData := include "packages.yaml" | fromYaml }}
{{ $winData := $pkgData.windows }}

$packages = @(
{{ range $winData.common }}
    "{{ . }}",
{{ end }}
{{/* Install desktop tools for workstation roles */}}
{{ if .is_workstation }}
{{ range $winData.extras }}
    "{{ . }}",
{{ end }}
{{ end }}
{{/* Install role-specific packages if defined */}}
{{ if hasKey $winData.roles .role }}
  {{ $rolePkgs := index $winData.roles .role }}
  {{ if $rolePkgs }}
    {{ range $rolePkgs }}
      "{{ . }}",
    {{ end }}
  {{ end }}
{{ end }}
    $null
) | Where-Object { $_ -ne $null }

function Install-Package {
    param([string]$id)
    Write-Host "Checking $id..." -ForegroundColor Gray
    
    # Special Check for Tailscale (Common issue on Windows)
    if ($id -eq "Tailscale.Tailscale") {
        $commonTailscalePaths = @(
            "$env:ProgramFiles\Tailscale\tailscale.exe",
            "$env:ProgramFiles (x86)\Tailscale\tailscale.exe",
            "C:\Program Files\Tailscale\tailscale.exe"
        )
        $isFound = $false
        foreach ($path in $commonTailscalePaths) { if (Test-Path $path) { $isFound = $true; break } }
        if ($isFound -or (Get-Service Tailscale -ErrorAction SilentlyContinue)) {
            Write-Host "  [+] Tailscale is already present (Service/Path found)." -ForegroundColor Green
            return
        }
    }

    # Standard Winget check
    & winget list --id $id --source winget -e >$null 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  [+] $id is already present." -ForegroundColor Green
        return
    }

    Write-Host "  [-] Installing $id..." -ForegroundColor Yellow
    
    # Try Winget first
    & winget install --id $id --source winget -e --accept-package-agreements --accept-source-agreements --silent --no-upgrade
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  [v] Successfully installed $id." -ForegroundColor Green
        return
    }

    # Special Fallback for Tailscale if Winget fails
    if ($id -eq "Tailscale.Tailscale") {
        Write-Host "  [!] Winget reported an error/abandoned. Tailscale might be running or Winget index is out of sync." -ForegroundColor Yellow
        # One last check before downloading 100MB
        if (Test-Path "C:\Program Files\Tailscale\tailscale.exe") {
            Write-Host "  [v] Tailscale verified at C:\Program Files\Tailscale\tailscale.exe. Skipping download." -ForegroundColor Green
            return
        }

        Write-Host "  [!] Attempting direct download fallback..." -ForegroundColor Yellow
        try {
            $url = "https://pkgs.tailscale.com/stable/tailscale-setup-full-latest.exe"
            $dest = "$env:TEMP\tailscale-setup.exe"
            Write-Host "  [>] Downloading from $url..." -ForegroundColor Gray
            Invoke-WebRequest -Uri $url -OutFile $dest -ErrorAction Stop
            Write-Host "  [>] Running installer..." -ForegroundColor Gray
            Start-Process -FilePath $dest -ArgumentList "/quiet", "/norestart" -Wait -ErrorAction Stop
            Write-Host "  [v] Successfully installed Tailscale via direct installer." -ForegroundColor Green
        } catch {
            Write-Warning "  [!] Fallback installation failed: $($_.Exception.Message)"
        }
    } else {
        Write-Warning "  [!] Failed to install $id. Error code: $LASTEXITCODE"
    }
}





foreach ($package in $packages) {
    if ($package) {
        Install-Package -id $package
    }
}

# Refresh Environment PATH
Write-Host "Refreshing Environment PATH..." -ForegroundColor Gray
$env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")

Write-Host "Windows Package Installation Complete!" -ForegroundColor Green

# Configure SSH Agent
Write-Host "Configure SSH Agent..." -ForegroundColor Cyan
Set-Service -Name ssh-agent -StartupType Automatic -ErrorAction SilentlyContinue
Start-Service ssh-agent -ErrorAction SilentlyContinue

{{ end }}





