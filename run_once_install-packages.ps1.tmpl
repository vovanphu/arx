{{- if eq .chezmoi.os "windows" -}}
# run_once_install-packages.ps1.tmpl
# This script runs only when the hash of this file changes.

Write-Host "Starting Windows Package Installation via Winget..." -ForegroundColor Cyan

{{- $pkgData := include "packages.yaml" | fromYaml -}}
{{- $winData := $pkgData.windows -}}

$packages = @()
{{ range $winData.common }}
$packages += "{{ . }}"
{{- end }}

# Only install 'extras' on Interactive roles:
if ("{{ .role }}" -eq "centaur" -or "{{ .role }}" -eq "chimera" -or "{{ .role }}" -eq "griffin") {
    {{ range $winData.extras }}
    $packages += "{{ . }}"
    {{- end }}
}

# Role-specific packages
{{ if hasKey $winData.roles .role -}}
    {{- $rolePkgs := index $winData.roles .role -}}
    {{- if $rolePkgs -}}
        {{- range $rolePkgs }}
        $packages += "{{ . }}"
        {{- end }}
    {{- end }}
{{- end }}

function Install-Package {
    param([string]$id)
    Write-Host "Checking $id..." -ForegroundColor Gray
    
    # Accurate check using exit code: 0 means found/installed
    & winget list --id $id --source winget -e >$null 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  [+] $id is already present." -ForegroundColor Green
        return
    }

    Write-Host "  [-] Installing $id..." -ForegroundColor Yellow
    # Force use of --source winget to avoid potential MS Store certificate issues
    & winget install --id $id --source winget -e --accept-package-agreements --accept-source-agreements --silent
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  [v] Successfully installed $id." -ForegroundColor Green
    } else {
        Write-Warning "  [!] Failed to install $id. Error code: $LASTEXITCODE"
    }
}

foreach ($package in $packages) {
    if ($package) {
        Install-Package -id $package
    }
}

# Refresh Environment PATH
Write-Host "Refreshing Environment PATH..." -ForegroundColor Gray
$env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")

Write-Host "Windows Package Installation Complete!" -ForegroundColor Green

# Configure SSH Agent
Write-Host "Configure SSH Agent..." -ForegroundColor Cyan
Set-Service -Name ssh-agent -StartupType Automatic -ErrorAction SilentlyContinue
Start-Service ssh-agent -ErrorAction SilentlyContinue

{{- end -}}



