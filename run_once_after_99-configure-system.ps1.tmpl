{{ if eq .chezmoi.os "windows" }}
# run_once_after_99-configure-system.ps1.tmpl
# This script manages system-level configurations like Hostname and Tailscale.

$targetName = "{{ .hostname }}"
$currentName = $env:COMPUTERNAME

Write-Host "--- System Configuration ---" -ForegroundColor Cyan

# 1. Tailscale Configuration (Automatic)
# Force refresh environment variables to find newly installed tailscale
$env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

$tailscaleBin = Get-Command tailscale -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source
$commonPaths = @(
    "C:\Program Files\Tailscale\tailscale.exe",
    "C:\Program Files (x86)\Tailscale\tailscale.exe",
    "$env:LOCALAPPDATA\Tailscale\tailscale.exe"
)

if (-not $tailscaleBin) {
    foreach ($path in $commonPaths) {
        if (Test-Path $path) {
            $tailscaleBin = $path
            break
        }
    }
}

if ($tailscaleBin) {
    Write-Host "Found Tailscale at: $tailscaleBin. Checking status..." -ForegroundColor Cyan
    $status = & $tailscaleBin status --peers=false 2>&1 | Out-String
    
    if ($status -match "Logged out" -or $status -match "Tailscale is stopped") {
        Write-Host "Tailscale is not logged in. Attempting auto-auth via Bitwarden..." -ForegroundColor Yellow
        if ($env:BW_SESSION) {
            try {
                $tsKey = bw get password "tailscale-auth-key"
                if ($tsKey) {
                    Write-Host "Tailscale Auth Key retrieved. Authenticating as '$targetName'..." -ForegroundColor Cyan
                    # Use --force-reauth to ensure the key is used if already partially logged in
                    & $tailscaleBin up --authkey $tsKey --hostname $targetName --accept-routes --force-reauth
                    Write-Host "Tailscale Connected Successfully!" -ForegroundColor Green
                }
            } catch {
                Write-Warning "Could not retrieve Tailscale key from Bitwarden."
            }
        } else {
            Write-Warning "Bitwarden session not active. Skipping Tailscale auto-login."
        }
    } else {
         Write-Host "Tailscale is already logged in. Updating hostname preference..." -ForegroundColor Green
         & $tailscaleBin set --hostname $targetName
    }
} else {
    Write-Warning "Tailscale binary not found in PATH or standard locations. Skipping auto-config."
}

# 2. OS Hostname Configuration (Prompt)
if ($currentName -ne $targetName) {
    Write-Host "Current System Name: $currentName" -ForegroundColor Yellow
    Write-Host "Target Mythos Name:  $targetName" -ForegroundColor Green
    
    Write-Host "Auto-correcting system name..." -ForegroundColor Cyan
    
    try {
        Rename-Computer -NewName $targetName -Force -ErrorAction Stop
        Write-Host "SUCCESS: Hostname changed to '$targetName'." -ForegroundColor Green
        Write-Host "IMPORTANT: You must RESTART your computer for this to take effect." -ForegroundColor Red
    } catch {
        Write-Error "Failed to rename computer. Please ensure you are running this script as ADMINISTRATOR."
    }
} else {
    Write-Host "System Hostname is already synced ($targetName)." -ForegroundColor Green
}

# 3. OpenSSH Default Shell Configuration
Write-Host "Configuring OpenSSH Default Shell to PowerShell..." -ForegroundColor Cyan
try {
    $openSshKeyPath = "HKLM:\SOFTWARE\OpenSSH"
    if (-not (Test-Path $openSshKeyPath)) {
        New-Item -Path $openSshKeyPath -Force | Out-Null
    }
    New-ItemProperty -Path $openSshKeyPath -Name DefaultShell -Value "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -PropertyType String -Force | Out-Null
    Write-Host "SUCCESS: OpenSSH Default Shell set to PowerShell." -ForegroundColor Green
} catch {
    Write-Warning "Failed to set OpenSSH Default Shell. Please run as Administrator."
}
{{ end }}

