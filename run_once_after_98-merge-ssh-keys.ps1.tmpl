{{ if eq .chezmoi.os "windows" }}
# run_once_after_98-merge-ssh-keys.ps1.tmpl
# Smart merge for authorized_keys and SSH config to preserve existing entries
# Works for ANY role - file-based detection instead of role-based

Write-Host "--- Smart Merge SSH Configuration ---" -ForegroundColor Cyan

# Backup Retention: Keep only 3 most recent backups
$allBackups = Get-ChildItem "$HOME\.ssh.backup.*" -Directory -ErrorAction SilentlyContinue |
              Sort-Object CreationTime -Descending
if ($allBackups.Count -gt 3) {
    Write-Host "Cleaning old SSH backups (keeping 3 most recent)..." -ForegroundColor Gray
    $toRemove = $allBackups | Select-Object -Skip 3
    foreach ($backup in $toRemove) {
        Remove-Item $backup.FullName -Recurse -Force -ErrorAction SilentlyContinue
    }
    Write-Host "  -> Removed $($toRemove.Count) old backup(s)" -ForegroundColor Gray
}

# Helper function: Find most recent backup
function Get-LatestSshBackup {
    return Get-ChildItem "$HOME\.ssh.backup.*" -Directory -ErrorAction SilentlyContinue |
           Sort-Object CreationTime -Descending |
           Select-Object -First 1
}

# ===== 1. MERGE AUTHORIZED_KEYS =====
$authorizedKeys = "$HOME\.ssh\authorized_keys"
if (Test-Path $authorizedKeys) {
    Write-Host "Found authorized_keys. Checking for backup to merge..." -ForegroundColor Gray

    $latestBackup = Get-LatestSshBackup

    if ($latestBackup -and (Test-Path "$($latestBackup.FullName)\authorized_keys")) {
        # Validate backup file is readable and not empty
        $backupFile = "$($latestBackup.FullName)\authorized_keys"
        try {
            $backupContent = Get-Content $backupFile -ErrorAction Stop
            if (-not $backupContent -or $backupContent.Count -eq 0) {
                Write-Host "  -> Backup file is empty. Skipping merge." -ForegroundColor Yellow
            } else {
                Write-Host "Merging authorized_keys with backup from: $($latestBackup.Name)" -ForegroundColor Yellow

                # Read new keys (generated by chezmoi)
                $newKeys = Get-Content $authorizedKeys -ErrorAction SilentlyContinue
                if (-not $newKeys) { $newKeys = @() }

                # Read old keys from backup
                $oldKeys = $backupContent

                # Create merged list (start with new keys)
                $mergedKeys = @()
                $mergedKeys += $newKeys

                # Track which old keys were preserved
                $preservedCount = 0

                foreach ($line in $oldKeys) {
                    # Skip comments and empty lines
                    if ($line -match '^\s*#' -or [string]::IsNullOrWhiteSpace($line)) {
                        continue
                    }

                    # Extract key fingerprint (type + key, ignore comment)
                    $keyPart = ($line -split '\s+')[0..1] -join ' '

                    # Check if this key already exists in new keys
                    $exists = $false
                    foreach ($newKey in $newKeys) {
                        if ($newKey -match [regex]::Escape($keyPart)) {
                            $exists = $true
                            break
                        }
                    }

                    # Preserve old key if not in new set
                    if (-not $exists) {
                        if ($preservedCount -eq 0) {
                            $mergedKeys += ""
                            $mergedKeys += "# ===== Preserved from previous configuration ====="
                        }
                        $mergedKeys += $line
                        $preservedCount++
                    }
                }

                # Write merged keys back
                $mergedKeys | Set-Content $authorizedKeys -Encoding UTF8
                Write-Host "  -> Merged successfully! Preserved $preservedCount old key(s)." -ForegroundColor Green
            }
        } catch {
            Write-Host "  -> Warning: Cannot read backup file. Skipping merge. Error: $($_.Exception.Message)" -ForegroundColor Yellow
        }
    } else {
        Write-Host "  -> No backup found. Keeping current authorized_keys as-is." -ForegroundColor Gray
    }
} else {
    Write-Host "No authorized_keys file found (expected for client-only roles)." -ForegroundColor Gray
}

# ===== 2. MERGE SSH CONFIG =====
$sshConfig = "$HOME\.ssh\config"
$sshConfigLocal = "$HOME\.ssh\config.local"

if (Test-Path $sshConfig) {
    Write-Host "Found SSH config. Checking for custom entries to preserve..." -ForegroundColor Gray

    $latestBackup = Get-LatestSshBackup

    # Ensure config.local Include directive exists
    $configContent = Get-Content $sshConfig -Raw
    if ($configContent -notmatch 'Include.*config\.local') {
        Write-Host "  -> Adding config.local include directive..." -ForegroundColor Yellow
        Add-Content $sshConfig "`n# Local overrides (not managed by dotfiles)"
        Add-Content $sshConfig "Include ~/.ssh/config.local"
    }

    # If there's a backup AND it has custom entries, help user merge
    if ($latestBackup -and (Test-Path "$($latestBackup.FullName)\config")) {
        $oldConfig = Get-Content "$($latestBackup.FullName)\config" -Raw
        $newConfig = Get-Content $sshConfig -Raw

        # Extract custom Host entries from old config (not managed by dotfiles)
        # Look for Host entries that don't match known patterns
        $customHosts = @()
        $oldConfigLines = $oldConfig -split "`n"
        $inCustomHost = $false
        $currentHost = @()

        foreach ($line in $oldConfigLines) {
            # Skip dotfiles-managed sections (comments indicate this)
            if ($line -match '# .ssh/config - Managed by Chezmoi' -or
                $line -match '# Role-Based Keys' -or
                $line -match '# Common Configuration') {
                $inCustomHost = $false
                continue
            }

            # Detect Host blocks
            if ($line -match '^Host\s+(.+)') {
                $hostName = $matches[1]
                # Check if this is NOT a dotfiles-managed host (github.com, *, etc.)
                if ($hostName -ne '*' -and $hostName -ne 'github.com' -and
                    -not ($newConfig -match "Host\s+$([regex]::Escape($hostName))")) {
                    $inCustomHost = $true
                    $currentHost = @($line)
                } else {
                    $inCustomHost = $false
                }
            } elseif ($inCustomHost) {
                $currentHost += $line
                # If we hit an empty line or new Host, save the block
                if ([string]::IsNullOrWhiteSpace($line) -or $line -match '^Host\s+') {
                    if ($currentHost.Count -gt 1) {
                        $customHosts += ($currentHost -join "`n")
                    }
                    $currentHost = @()
                    if ($line -match '^Host\s+') {
                        $currentHost = @($line)
                    }
                }
            }
        }

        # Save last host block if exists
        if ($inCustomHost -and $currentHost.Count -gt 1) {
            $customHosts += ($currentHost -join "`n")
        }

        # If custom hosts found, append to config.local
        if ($customHosts.Count -gt 0) {
            if (-not (Test-Path $sshConfigLocal)) {
                New-Item -ItemType File -Path $sshConfigLocal -Force | Out-Null
            }

            Write-Host "  -> Found $($customHosts.Count) custom Host entry/entries in backup." -ForegroundColor Yellow
            Write-Host "  -> Merging into config.local..." -ForegroundColor Yellow

            Add-Content $sshConfigLocal "`n# ===== Migrated from previous config ====="
            foreach ($hostBlock in $customHosts) {
                Add-Content $sshConfigLocal $hostBlock
                Add-Content $sshConfigLocal ""
            }

            Write-Host "  -> Custom entries preserved in config.local" -ForegroundColor Green
        } else {
            Write-Host "  -> No custom Host entries found in backup." -ForegroundColor Gray
        }
    }
} else {
    Write-Host "No SSH config file found (will be created by chezmoi if needed)." -ForegroundColor Gray
}

Write-Host "SSH configuration merge complete." -ForegroundColor Green
{{ end }}
